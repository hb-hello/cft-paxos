syntax = "proto3";

import "google/protobuf/empty.proto";

option java_package = "org.example";

service MessageService {
  rpc Request (ClientRequest) returns (ClientReply) {};

  rpc Prepare (PrepareMessage) returns (PromiseMessage) {};
  rpc Accept (AcceptMessage) returns (AcceptedMessage) {};
  rpc NewView (NewViewMessage) returns (stream AcceptedMessage) {};
  rpc Accepted (AcceptedMessage) returns (google.protobuf.Empty) {};
  rpc Commit (CommitMessage) returns (google.protobuf.Empty) {};
  rpc ForwardClientRequest (ClientRequest) returns (google.protobuf.Empty) {};

  rpc SetActiveFlag (ActiveFlag) returns (Acknowledgement) {};

  rpc SendCheckpoint(CheckpointMessage) returns (Acknowledgement);

  rpc FailLeader(google.protobuf.Empty) returns (Acknowledgement);

  // for cli
  rpc GetLog(google.protobuf.Empty) returns (CLIResponse) {};
  rpc GetDB(google.protobuf.Empty) returns (CLIResponse) {};
  rpc GetStatus(SequenceNumber) returns (CLIResponse) {};
  rpc GetNewViews(google.protobuf.Empty) returns (CLIResponse) {};
}

// CLI to server request

message ActiveFlag {
    bool active_flag = 1;
}

message Acknowledgement {
    bool status = 1;
}

message SequenceNumber {
    int64 sequence_number = 1;
}

message CLIResponse {
    string cli_response = 1;
}

// Client - server connections

// Client to server request

message Transaction {
  string sender = 1;
  string receiver = 2;
  double amount = 3;
}

message ClientRequest {
  Transaction transaction = 1;
  int64 timestamp = 2;
  string client_id = 3;
}

// Server to client reply

message ClientReply {
  string sender_id = 1;
  int64 timestamp = 2;
  string client_id = 3;
  bool result = 4;
}

// Server - server connections

message Ballot {
  int32 instance = 1;
  string sender_id = 2;
}

// Prepare phase
message PrepareMessage {
  Ballot ballot = 1;
}

message PromiseMessage {
  Ballot ballot = 1;
  repeated AcceptMessage accept_log = 2;
  string sender_id = 3;
}

// Accept phase
message AcceptMessage {
  Ballot ballot = 1;
  int64 sequence_number = 2;
  ClientRequest request = 3;
}

message AcceptedMessage {
  Ballot ballot = 1;
  int64 sequence_number = 2;
  ClientRequest request = 3;
  string sender_id = 4;
}

message NewViewMessage {
  Ballot ballot = 1;
  repeated AcceptMessage accept_log = 2;
}

// Commit phase
message CommitMessage {
  Ballot ballot = 1;
  int64 sequence_number = 2;
  ClientRequest request = 3;
}

// A map representing the entire state of all bank accounts
message AccountBalances {
  map<string, double> balances = 1;
}

// Message for broadcasting a checkpoint
message CheckpointMessage {
  int32 last_sequence_number = 1;
  string state_digest = 2;          // The SHA-256 hash of the state
  AccountBalances state = 3;      // The full state itself
}